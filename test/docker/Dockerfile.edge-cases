# Edge case testing for ClawRouter + OpenClaw integration
FROM node:22-slim

# Install dependencies
RUN apt-get update && \
    apt-get install -y git curl jq netcat-openbsd procps lsof openssl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install OpenClaw globally
RUN npm install -g openclaw@latest

# Create test user
RUN useradd -m -s /bin/bash testuser

# Switch to test user
USER testuser
WORKDIR /home/testuser

# Set up npm global prefix
RUN mkdir -p ~/.npm-global && \
    npm config set prefix ~/.npm-global

# Add npm global bin to PATH
ENV PATH="/home/testuser/.npm-global/bin:${PATH}"

# Initialize OpenClaw config
RUN mkdir -p ~/.openclaw/agents/main/agent

# Copy test files
COPY --chown=testuser:testuser test/docker/edge-case-tests.sh /home/testuser/
COPY --chown=testuser:testuser test/docker/test-scenarios/ /home/testuser/test-scenarios/

# Make executable
USER root
RUN chmod +x /home/testuser/edge-case-tests.sh
USER testuser

CMD ["/bin/bash", "/home/testuser/edge-case-tests.sh"]
